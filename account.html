<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        #videos-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            flex-wrap: wrap;
            overflow-x: auto;
            padding: 10px;
            justify-items: center;
        }

        .videos-grid-item {
            width: 300px;
            min-height: 200px;
            padding: 0 !important;
            margin: 10px;
        }

        .video-thumbnail {
            border-radius: 0.75rem;
        }

        .video-bottom-row {
            display: flex;
            flex-direction: row;
            margin: 10px;
        }

        .video-author-img {
            border-radius: 50%;
            margin: 5px;
            width: 50px;
            height: 50px;
            margin-right: 15px;
        }

        .menu {
            padding: 10px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .json-editor-btn-delete.delete::after , .json-editor-btn-delete.delete::before {
            display: none !important;
        }

        .json-editor-btn-delete.delete {
            max-width: none !important;
            width: auto !important;
            background-color: transparent !important;
        }

        #messagesTableBody tr:hover {
            background: gainsboro !important;
        }
    </style>

    <!--Firebase-->
    <script src="firebase.js" type="module" defer></script>

    <!--JSON Editor-->
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

    <!--WYSIWYG Editor-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sceditor@3/minified/themes/default.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sceditor@3/minified/sceditor.min.js"></script>
</head>

<body>
    <div class="columns">
        <div class="column is-one-quarter-tablet is-one-fifth-widescreen">
            <img src="./assets/logo/original_logo.png" alt="Combiete Lantey" width="175" style="padding: 10px;" />
            <div class="menu">
                <p class="menu-label">Content</p>
                <ul class="menu-list">
                    <li>
                        <button onclick="openPage('videos')">
                            <span class="icon-text">
                                <span class="icon">
                                    <span class="material-icons">video_library</span>
                                </span>
                                <span>Videos</span>
                            </span>
                        </button>
                        <button onclick="openPage('messages')">
                            <span class="icon-text">
                                <span class="icon">
                                    <span class="material-icons">mail</span>
                                </span>
                                <span>Messages</span>
                            </span>
                        </button>
                    </li>
                </ul>
                <p class="menu-label">Account</p>
                <ul class="menu-list">
                    <li>
                        <button onclick="openPage('profile')">
                            <span class="icon-text">
                                <span class="icon">
                                    <span class="material-icons">account_circle</span>
                                </span>
                                <span>Profile</span>
                            </span>
                        </button>
                    </li>
                    <li>
                        <button href="#">
                            <span class="icon-text">
                                <span class="icon">
                                    <span class="material-icons">settings</span>
                                </span>
                                <span>Settings</span>
                            </span>
                        </button>
                    </li>
                    <li>
                        <button href="#">
                            <span class="icon-text">
                                <span class="icon">
                                    <span class="material-icons">logout</span>
                                </span>
                                <span>Logout</span>
                            </span>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        <div class="column" style="padding: 20px;">
            <div class="box page" id="videos">
                <h1 class="title">Videos</h1>
                <button class="button is-primary icon-text js-modal-trigger" data-target="dlgNewVideo">
                    <span class="icon">
                        <span class="material-icons">add</span>
                    </span>
                    New Video
                </button>
                <div id="videos-grid">
                    <!-- Video items will be dynamically loaded here -->
                    <!-- Example video item --
                    <div class="videos-grid-item box">
                        <img src="https://placehold.co/1600x900.png?font=roboto" alt="Video thumbnail" class="video-thumbnail">
                        <div class="video-bottom-row">
                            <!--<img src="https://placehold.co/64x64.png?font=roboto" alt="User" class="video-author-img">--
                            <div class="video-bottom-right">
                                <p class="video-title"><strong>Video title</strong></p>
                                <p class="video-description"></p>
                            </div>
                        </div>
                    </div>-->
                    <!-- Add more video items here -->
                </div>
            </div>
            <div class="box page" id="video">
                <img src="https://placehold.co/1600x900.png?font=roboto" alt="currentVideoThumbnail" id="currentVideoThumbnail" />
                <h1 class="title" id="currentVideoName">Title</h1>
                <p class="icon-text" style="display: none;">
                    <span class="icon">
                        <span class="material-icons">thumb_up</span>
                    </span>
                    <span id="currentVideoLikes">0</span>
                    <span class="icon">
                        <span class="material-icons">thumb_down</span>
                    </span>
                    <span id="currentVideoDislikes">0</span>
                </p>
                <article class="content" id="currentVideoDesc">Description</article>
                <p class="buttons">
                    <a href="#" class="button" id="currentVideoLink">Open video link</a>
                    <a href="#" class="button is-danger" id="currentVideoDelete">Delete video</a>
                </p>
            </div>
            <div class="box page active" id="messages">
                <h1 class="title">Messages</h1>
                <!-- Messages will be dynamically loaded here -->
                <!-- Add more message items here -->
                <table class="table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Sender</th>
                            <th>Subject</th>
                        </tr>
                    </thead>
                    <tbody id="messagesTableBody">
                        <!-- Example message item -->
                        <!-- Add more message items here -->
                        <tr>
                            <td><i class="material-icons">mail</i></td>
                            <td>clant</td>
                            <td>Hello, this is a test message!</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="box page" id="message">
                <h1 class="title" id="currentMsgSubject">Message</h1>
                <p class="icon-text" style="display: none;">
                    <span class="icon">
                        <span class="material-icons">thumb_up</span>
                    </span>
                    <span id="currentMsgLikes">0</span>
                    <span class="icon">
                        <span class="material-icons">thumb_down</span>
                    </span>
                    <span id="currentMsgDislikes">0</span>
                </p>
                <a id="currentMsgSenderLink" class="box" href="#">
                    <article class="media">
                        <div class="media-left">
                            <figure class="image is-64x64">
                                <img src="https://bulma.io/assets/images/placeholders/128x128.png"
                                    alt="Image" />
                            </figure>
                        </div>
                        <div class="media-content">
                            <div class="content" style="padding: 0;">
                                <p>
                                    <strong>John Smith</strong>
                                    <small>@johnsmith</small>
                                </p>
                            </div>
                        </div>
                    </article>
                </a>
                <article class="content" id="currentMsgContent">Content</article>
                <p class="buttons">
                    <a href="#" class="button is-danger" id="currentMsgDelete">Delete message</a>
                </p>
            </div>
            <div id="profile" class="box page">
                <h1 class="title">Profile</h1>
                <figure>
                    <img src="https://placehold.co/900x300.png?font=roboto" alt="Image" />
                </figure>
                <div class="box">
                    <article class="media">
                      <div class="media-left">
                        <figure class="image is-64x64">
                          <img src="https://bulma.io/assets/images/placeholders/128x128.png" alt="Image" />
                        </figure>
                      </div>
                      <div class="media-content">
                        <div class="content">
                          <p>
                            <input id="txtUserDisplayName" class="input" type="text" placeholder="Display name" />
                            <input id="txtUserHandle" class="input" type="text" placeholder="Handle" />
                            <textarea id="txtUserBio" placeholder="Bio"></textarea>
                          </p>
                        </div>
                      </div>
                    </article>
                  </div>
            </div>
        </div>
    </div>
    <div class="modal" id="dlgNewVideo">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">New Video</p>
            </header>
            <section class="modal-card-body">
                <div id="newVidSettingsContainer"></div>
            </section>
            <footer class="modal-card-foot">
                <span class="error" id="newVidError"></span>
                <div class="buttons">
                    <button class="button is-success" id="btnUploadNewVid">Upload!</button>
                    <button class="button">Close</button>
                </div>
            </footer>
        </div>
    </div>
    <div class="modal" id="dlgNewMessage">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">New Message</p>
            </header>
            <section class="modal-card-body">
                <div id="newMsgSettingsContainer"></div>
            </section>
            <footer class="modal-card-foot">
                <span class="error" id="newMsgError"></span>
                <div class="buttons">
                    <button class="button is-success" id="btnSendNewMsg">Send!</button>
                    <button class="button">Close</button>
                </div>
            </footer>
        </div>
    </div>
    <script>
        function openPage(id) {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
    <script type="module">
        import * as sbApp from "./firebase.js";
        // Function to truncate strings
        function truncateString(str, length, ending) {
            if (str.length > length) {
                return str.substring(0, length - ending.length) + ending;
            } else {
                return str;
            }
        }
        // Function to load video items
        function loadVideos() {
            sbApp.default.fetchVideosByCurrentUser().then(videos => {
                const videosGrid = document.getElementById('videos-grid');
                videos.data.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.classList.add('videos-grid-item');
                    videoItem.classList.add('box');
                    videoItem.innerHTML = `
                        <img src="${video.thumbnail.length > 0 ? video.thumbnail : "https://placehold.co/1600x900.png?font=roboto"}" alt="Video thumbnail" class="video-thumbnail" width="1600" height="900">
                        <div class="video-bottom-row">
                            <div class="video-bottom-right">
                                <p class="video-title"><strong>${video.title}</strong></p>
                                <p class="video-description">${truncateString(video.description, 75, "...")}</p>
                            </div>
                        </div>
                    `;
                    videoItem.addEventListener('click', () => loadSingleVideo(video.id));
                    videosGrid.appendChild(videoItem);
                });
                if (videos.data.length == 0) {
                    const noVideos = document.createElement("p");
                    noVideos.textContent = "You have not created any videos. Click 'New Video' to create a new video.";
                    videosGrid.appendChild(noVideos);
                }
            });
        }
        // Function to load single video
        function loadSingleVideo(videoId) {
            sbApp.default.fetchVideoById(videoId).then(video => {
                document.getElementById("currentVideoName").innerHTML = video.data[0].title;
                document.getElementById("currentVideoDesc").innerHTML = video.data[0].description;
                document.getElementById("currentVideoThumbnail").src = video.data[0].thumbnail.length > 0? video.thumbnail : "https://placehold.co/1600x900.png?font=roboto";
                document.getElementById("currentVideoLikes").innerHTML = video.data[0].likes;
                document.getElementById("currentVideoDislikes").innerHTML = video.data[0].dislikes;
                //document.getElementById("currentVideoComments").innerHTML = video.data[0].comments;
                document.getElementById("currentVideoLink").href = "video?id=" + video.data[0].id;
                openPage("video");
                document.getElementById("currentVideoDelete").onclick = () => {
                    // Open a browser dialog
                    const confirmation = confirm("Are you sure you want to delete this video?\nThis action is irreversible!");
                    if (confirmation) {
                        sbApp.default.deleteVideo(videoId).then((res) => {
                            if (res.error) {
                                console.error("Error deleting video:", res.error);
                                alert("Error deleting video:", res.error);
                                return;
                            }
                            alert("Video deleted successfully!");
                            location.reload();
                        });
                    }
                }
            });
        }
        // Function to load messages to current user
        function loadMessages() {
            sbApp.default.fetchMessagesByCurrentUser().then(messages => {
                const messagesTableBody = document.getElementById('messagesTableBody');
                messages.data.forEach(message => {
                    const messageItem = document.createElement('tr');
                    messageItem.innerHTML = `
                        <td><i class="material-icons">mail</i></td>
                        <td>${message.sender.display_name}</td>
                        <td>${message.subject}</td>
                    `;
                    messageItem.addEventListener('click', () => {
                        loadSingleMessage(message.id)
                    });
                    messagesTableBody.appendChild(messageItem);
                });
                if (messages.data.length == 0) {
                    const noMessages = document.createElement("p");
                    noMessages.textContent = "You have not received any messages.";
                    messagesTableBody.appendChild(noMessages);
                }
            });
        }
        // Function to load single message
        function loadSingleMessage(messageId) {
            sbApp.default.fetchMessageById(messageId).then(message => {
                console.log(message);
                
                document.getElementById("currentMsgSenderLink").innerHTML = `
                    <article class="media">
                        <div class="media-left">
                            <figure class="image is-64x64">
                                <img src="${message.data[0].sender.photo_url}"
                                    alt="Image" />
                            </figure>
                        </div>
                        <div class="media-content">
                            <div class="content" style="padding: 0;">
                                <p>
                                    <strong>${message.data[0].sender.display_name}</strong>
                                    <small>${message.data[0].sender.handle}</small>
                                </p>
                            </div>
                        </div>
                    </article>
                `; document.getElementById("currentMsgSenderLink").href = "user?id="+message.data[0].sender.id;
                document.getElementById("currentMsgSubject").innerHTML = message.data[0].subject;
                document.getElementById("currentMsgContent").innerHTML = message.data[0].content;
                openPage("message");
                document.getElementById("currentMsgDelete").onclick = () => {
                    // Open a browser dialog
                    const confirmation = confirm("Are you sure you want to delete this message?\nThis action is irreversible!");
                    if (confirmation) {
                        sbApp.default.deleteMessage(messageId).then((res) => {
                            if (res.error) {
                                console.error("Error deleting message:", res.error);
                                alert("Error deleting message:", res.error);
                                return;
                            }
                            alert("Message deleted successfully!");
                            location.reload();
                        });
                    }
                }
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Functions to open and close a modal
            function openModal($el) {
                $el.classList.add('is-active');
            }

            function closeModal($el) {
                $el.classList.remove('is-active');
            }

            function closeAllModals() {
                (document.querySelectorAll('.modal') || []).forEach(($modal) => {
                    closeModal($modal);
                });
            }

            // Add a click event on buttons to open a specific modal
            (document.querySelectorAll('.js-modal-trigger') || []).forEach(($trigger) => {
                const modal = $trigger.dataset.target;
                const $target = document.getElementById(modal);

                $trigger.addEventListener('click', () => {
                    openModal($target);
                });
            });

            // Add a click event on various child elements to close the parent modal
            (document.querySelectorAll('.modal-background, .modal-close, .modal-card-head .delete, .modal-card-foot .button') || []).forEach(($close) => {
                const $target = $close.closest('.modal');

                $close.addEventListener('click', () => {
                    closeModal($target);
                });
            });

            // Add a keyboard event to close all modals
            document.addEventListener('keydown', (event) => {
                if (event.key === "Escape") {
                    closeAllModals();
                }
            });
        });
        window.onload = () => {
            // If "page" url parameter is specified, goto the page
            const page = new URLSearchParams(window.location.search).get('page');
            if (page) openPage(page);
            // Fetch and display videos from Supabase
            // Supabase client can be retrieved from sbApp.default.supabase
            console.log("Videos:", sbApp.default.fetchVideos());
            if (!sbApp.default.isSignedIn()) window.location.href = "/auth";
            loadVideos();
            // JSONEditor for new video
            const newVidEditor = new JSONEditor(document.getElementById("newVidSettingsContainer"), {
                theme: "spectre",
                showErrors: "change",
                disable_properties: true,
                disable_collapse: true,
                disable_edit_json: true,
                enable_array_copy: true,
                require_by_default: true,
                compact: true,
                schema: {
                    type: "object",
                    properties: {
                        title: { 
                            type: "string" 
                        },
                        description: {
                            type: "string",
                            format: "xhtml",
                            options: {
                                sceditor: {}
                            }
                        },
                        video: {
                            type: "string",
                            format: "file",
                            media: {
                                binaryEncoding: "base64",
                                type: "video/*",
                            }
                        },
                        thumbnail: {
                            type: "string",
                            format: "file",
                            media: {
                                binaryEncoding: "base64",
                                type: "image/*",
                            }
                        },
                        tracks: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    langName: {
                                        type: "string"
                                    },
                                    src: {
                                        type: "string",
                                        format: "file",
                                        media: {
                                            binaryEncoding: "base64",
                                            type: "vtt",
                                        }
                                    },
                                    srclang: {
                                        type: "string"
                                    }
                                }
                            }
                        }
                    }
                }
            });
            document.getElementById("btnUploadNewVid").onclick = function () {
                this.classList.add("is-loading"); // Show loading
                this.disabled = true; // Avoid creating multiple instances
                const videoData = newVidEditor.getValue();
                // Validate video 
                if (!videoData.video) {
                    alert("Please upload a video.");
                    this.classList.remove("is-loading"); // Hide loading
                    this.disabled = false; // Enable creating again
                    return;
                }
                // Validate tracks
                if (videoData.tracks.length > 0 &&!videoData.tracks.every(track => track.langName && track.src && track.srclang)) {
                    alert("Please provide all language information for all tracks.");
                    this.classList.remove("is-loading"); // Hide loading
                    this.disabled = false; // Enable creating again
                    return;
                }
                sbApp.default.createVideo(videoData.title, videoData.description, videoData.video, videoData.thumbnail, videoData.tracks).then(res => {
                    if (res.error) {
                        alert("Error creating video: " + res.error.message);
                    } else {
                        alert("Video created successfully!");
                        loadVideos(); // Reload videos
                        closeModal(document.getElementById("dlgNewVideo"));
                        newVidEditor.setValue({
                            title: "",
                            description: "",
                            video: "",
                            thumbnail: "",
                            tracks: []
                        }); // Reset JSONEditor
                    }
                });
                this.classList.remove("is-loading"); // Hide loading
                this.disabled = false; // Enable creating again
            };
            // JSONEditor for new message
            var newMsgEditor = null;
            sbApp.default.getUsersEnum().then(ids => {
                newMsgEditor = new JSONEditor(document.getElementById("newMsgSettingsContainer"), {
                    theme: "spectre",
                    showErrors: "change",
                    disable_properties: true,
                    disable_collapse: true,
                    disable_edit_json: true,
                    enable_array_copy: true,
                    require_by_default: true,
                    compact: true,
                    schema: {
                        type: "object",
                        properties: {
                            subject: { 
                                type: "string" 
                            },
                            content: {
                                type: "string",
                                format: "xhtml",
                                options: {
                                    sceditor: {}
                                }
                            },
                            recipients: {
                                type: "array",
                                format: "table",
                                uniqueItems: true,
                                items: {
                                    type: "enum",
                                    enum: ids.data.map(id => ({ value: id, label: id }))
                                }
                            }
                        }
                    }
                })
                document.getElementById("btnSendNewMsg").onclick = function () {
                    this.classList.add("is-loading"); // Show loading
                    this.disabled = true; // Avoid sending multiple instances
                    const msgData = newMsgEditor.getValue();
                    // Validate recipients
                    if (msgData.recipients.length === 0) {
                        alert("Please select at least one recipient.");
                        this.classList.remove("is-loading"); // Hide loading
                        this.disabled = false; // Enable sending again
                        return;
                    }
                    sbApp.default.sendMessage(msgData.subject, msgData.recipients, msgData.content).then(res => {
                        if (res.error) {
                            alert("Error sending message: " + res.error);
                        } else {
                            alert("Message sent successfully!");
                            closeModal(document.getElementById("dlgNewMessage"));
                            newMsgEditor.setValue({
                                subject: "",
                                content: "",
                                recipients: []
                            }); // Reset JSONEditor
                        }
                    });
                }
            });
            loadMessages();
        };
    </script>
</body>

</html>